<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Finger Tracking</title>
    <style>
        /* ... (keep existing styles the same) ... */
    </style>
</head>
<body>
    <div id="status">ðŸŸ  Initializing...</div>
    <div id="videoContainer">
        <video id="videoElement" autoplay playsinline></video>
        <div id="trackBox" class="track-box"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        const statusElement = document.getElementById('status');
        const videoElement = document.getElementById('videoElement');
        const trackBox = document.getElementById('trackBox');
        let isTracking = false;

        // 1. MEDIAPIPE HANDS CONFIGURATION
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 0,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        // 2. COORDINATE MAPPING FUNCTION
        function mapCoordinates(x, y) {
            const videoRect = videoElement.getBoundingClientRect();
            const scaleX = videoElement.videoWidth / videoRect.width;
            const scaleY = videoElement.videoHeight / videoRect.height;
            
            return {
                x: (x / scaleX) + videoRect.left,
                y: (y / scaleY) + videoRect.top
            };
        }

        // 3. HAND RESULTS PROCESSING
        hands.onResults((results) => {
            if (results.multiHandLandmarks?.[0]) {
                const landmarks = results.multiHandLandmarks[0];
                const indexTip = landmarks[8];
                const middleTip = landmarks[12];
                
                const indexPos = mapCoordinates(indexTip.x * videoElement.videoWidth, 
                                              indexTip.y * videoElement.videoHeight);
                const middlePos = mapCoordinates(middleTip.x * videoElement.videoWidth, 
                                               middleTip.y * videoElement.videoHeight);

                const boxWidth = Math.abs(indexPos.x - middlePos.x) + 40;
                const boxHeight = Math.abs(indexPos.y - middlePos.y) + 40;
                const centerX = (indexPos.x + middlePos.x) / 2;
                const centerY = (indexPos.y + middlePos.y) / 2;

                trackBox.style.display = 'block';
                trackBox.style.left = `${centerX}px`;
                trackBox.style.top = `${centerY}px`;
                trackBox.style.width = `${boxWidth}px`;
                trackBox.style.height = `${boxHeight}px`;

                statusElement.textContent = "ðŸŸ¢ Tracking active!";
                isTracking = true;
            } else {
                trackBox.style.display = 'none';
                if (isTracking) {
                    statusElement.textContent = "ðŸŸ  Show your hand...";
                    isTracking = false;
                }
            }
        });

        // 4. CAMERA INITIALIZATION
        async function main() {
            try {
                const camera = new Camera(videoElement, {
                    onFrame: async () => {
                        try {
                            await hands.send({ image: videoElement });
                        } catch (error) {
                            statusElement.textContent = "ðŸ”´ Tracking error - Move hand into view";
                        }
                    },
                    width: 1280,
                    height: 720,
                    facingMode: 'environment'
                });

                await camera.start();
                statusElement.textContent = "ðŸŸ¢ Camera ready! Show your hand";

                // iOS mirror fix
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    videoElement.style.transform = 'scale(-1, 1)';
                }

            } catch (error) {
                statusElement.textContent = `ðŸ”´ Error: ${error.message}`;
                console.error('Camera initialization error:', error);
            }
        }

        // 5. START APPLICATION
        main();

        // 6. CLEANUP ON UNLOAD
        window.addEventListener('beforeunload', () => {
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
